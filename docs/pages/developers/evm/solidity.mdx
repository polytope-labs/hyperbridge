# ISMP Solidity
ISMP Solidity is an implementation of ISMP for the EVM, it allows any integrated smart contract to send and receive secure messages through the Hyperbridge Nexus.    
Let's look into it's different components:

## EvmHost

The EvmHost contract, implementing the `IIsmpHost` interface, is a stateful module responsible for all protocol storage needs. It manages a comprehensive store encompassing consensus states, state machine commitments, request/response commitments and receipts.  
Additionally, it implements the `IIsmpDispatcher` interface, providing methods for contracts to dispatch requests and responses to the Hyperbridge Nexus.

```solidity
// The IsmpHost is the core of the interoperable state machine protocol which encapsulates the interfaces
// required for handlers and modules.
interface IIsmpHost is IDispatcher {
    /**
     * @return the host admin
     */
    function admin() external returns (address);

    /**
     * @return the address of the fee token ERC-20 contract on this state machine
     */
    function feeToken() external view returns (address);

    /**
     * @return the per-byte fee for outgoing requests.
     */
    function perByteFee() external view returns (uint256);

    /**
     * @return the host state machine id
     */
    function host() external view returns (bytes memory);

    /**
     * @return the state machine identifier for the connected hyperbridge instance
     */
    function hyperbridge() external view returns (bytes memory);

    /**
     * @return the host timestamp
     */
    function timestamp() external view returns (uint256);

    /**
     * @return the `frozen` status
     */
    function frozen() external view returns (bool);

    /**
     * @param height - state machine height
     * @return the state commitment at `height`
     */
    function stateMachineCommitment(StateMachineHeight memory height) external returns (StateCommitment memory);

    /**
     * @param height - state machine height
     * @return the state machine commitment update time at `height`
     */
    function stateMachineCommitmentUpdateTime(StateMachineHeight memory height) external returns (uint256);

    /**
     * @dev Should return a handle to the consensus client based on the id
     * @return the consensus client contract
     */
    function consensusClient() external view returns (address);

    /**
     * @return the last updated time of the consensus client
     */
    function consensusUpdateTime() external view returns (uint256);

    /**
     * @return the latest state machine height for the given stateMachineId. If it returns 0, the state machine is unsupported.
     */
    function latestStateMachineHeight(uint256 stateMachineId) external view returns (uint256);

    /**
     * @return the state of the consensus client
     */
    function consensusState() external view returns (bytes memory);

    /**
     * @param commitment - commitment to the request
     * @return relayer address
     */
    function requestReceipts(bytes32 commitment) external view returns (address);

    /**
     * @param commitment - commitment to the request of the response
     * @return response receipt
     */
    function responseReceipts(bytes32 commitment) external view returns (ResponseReceipt memory);

    /**
     * @param commitment - commitment to the request
     * @return existence status of an outgoing request commitment
     */
    function requestCommitments(bytes32 commitment) external view returns (FeeMetadata memory);

    /**
     * @param commitment - commitment to the response
     * @return existence status of an outgoing response commitment
     */
    function responseCommitments(bytes32 commitment) external view returns (FeeMetadata memory);

    /**
     * @return the challenge period
     */
    function challengePeriod() external view returns (uint256);

    /**
     * @return the unstaking period
     */
    function unStakingPeriod() external view returns (uint256);

    /**
     * @dev Store an encoded consensus state
     * @param state new consensus state
     */
    function storeConsensusState(bytes memory state) external;

    /**
     * @dev Store the commitment at `state height`
     * @param height state machine height
     * @param commitment state commitment
     */
    function storeStateMachineCommitment(StateMachineHeight memory height, StateCommitment memory commitment)
        external;

    /**
     * @dev Delete the state commitment at given state height.
     */
    function deleteStateMachineCommitment(StateMachineHeight memory height, address fisherman) external;

    /**
     * @dev Dispatch an incoming request to destination module
     * @param request - post request
     */
    function dispatchIncoming(PostRequest memory request, address relayer) external;

    /**
     * @dev Dispatch an incoming post response to source module
     * @param response - post response
     */
    function dispatchIncoming(PostResponse memory response, address relayer) external;

    /**
     * @dev Dispatch an incoming get response to source module
     * @param response - get response
     */
    function dispatchIncoming(GetResponse memory response, address relayer) external;

    /**
     * @dev Dispatch an incoming get timeout to source module
     * @param timeout - timed-out get request
     */
    function dispatchIncoming(GetRequest memory timeout, FeeMetadata memory meta, bytes32 commitment) external;

    /**
     * @dev Dispatch an incoming post timeout to source module
     * @param timeout - timed-out post request
     */
    function dispatchIncoming(PostRequest memory timeout, FeeMetadata memory meta, bytes32 commitment) external;

    /**
     * @dev Dispatch an incoming post response timeout to source module
     * @param timeout - timed-out post response
     */
    function dispatchIncoming(PostResponse memory timeout, FeeMetadata memory meta, bytes32 commitment) external;
}

interface IDispatcher {
    /**
     * @dev Dispatch a post request to the ISMP router.
     * @param request - post request
     * @return commitment - the request commitment
     */
    function dispatch(DispatchPost memory request) external returns (bytes32 commitment);

    /**
     * @dev Dispatch a GET request to the ISMP router.
     * @param request - get request
     * @return commitment - the request commitment
     */
    function dispatch(DispatchGet memory request) external returns (bytes32 commitment);

    /**
     * @dev Provide a response to a previously received request.
     * @param response - post response
     * @return commitment - the request commitment
     */
    function dispatch(DispatchPostResponse memory response) external returns (bytes32 commitment);
}

```

## EvmHandler

The Handler contract (implementing `IHandler` interface) is stateless, handling consensus and state proof verifications for all allowed ismp message types.  
Upon successful verification, it delegates state persistence and dispatch to the EvmHost contract.

This decoupled design of the Handler from the Host allows independent upgrades to verification mechanisms without impacting the core protocol, enabling future adoption of more efficient consensus and state verification methods
with no changes to the protocol or dependent contracts.

```solidity
interface IHandler {
    /**
     * @dev Handle an incoming consensus message. This uses the IConsensusClient contract registered on the host to perform the consensus message verification.
     * @param host - Ismp host
     * @param proof - consensus proof
     */
    function handleConsensus(IIsmpHost host, bytes memory proof) external;

    /**
     * @dev Handles incoming POST requests, check request proofs, message delay and timeouts, then dispatch POST requests to the apropriate contracts.
     * @param host - Ismp host
     * @param request - batch post requests
     *
    function handlePostRequests(IIsmpHost host, PostRequestMessage memory request) external;

    /**
     * @dev Handles incoming POST responses, check response proofs, message delay and timeouts, then dispatch POST responses to the apropriate contracts.
     * @param host - Ismp host
     * @param response - batch post responses
     */
    function handlePostResponses(IIsmpHost host, PostResponseMessage memory response) external;

    /**
     * @dev check response proofs, message delay and timeouts, then dispatch get responses to modules
     * @param host - Ismp host
     * @param message - batch get responses
     */
    function handleGetResponses(IIsmpHost host, GetResponseMessage memory message) external;

    /**
     * @dev check timeout proofs then dispatch to modules
     * @param host - Ismp host
     * @param message - batch post request timeouts
     */
    function handlePostRequestTimeouts(IIsmpHost host, PostRequestTimeoutMessage memory message) external;

    /**
     * @dev check timeout proofs then dispatch to modules
     * @param host - Ismp host
     * @param message - batch post response timeouts
     */
    function handlePostResponseTimeouts(IIsmpHost host, PostResponseTimeoutMessage memory message) external;

    /**
     * @dev dispatch to modules
     * @param host - Ismp host
     * @param message - batch get request timeouts
     */
    function handleGetRequestTimeouts(IIsmpHost host, GetTimeoutMessage memory message) external;
}

```

In the next section we'll look into hands-on examples of how to send and receive messages using ISMP.
