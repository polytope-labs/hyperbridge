use polkadot_sdk::*;

use beefy_prover::Prover;
use beefy_verifier_primitives::ConsensusState;
use codec::{Decode, Encode};
use ethers::abi::{AbiDecode, AbiEncode, Token, Uint};
use forge_testsuite::Runner;
use futures::stream::StreamExt;
use hex_literal::hex;
use ismp_solidity_abi::{
	beefy::{BeefyConsensusProof, BeefyConsensusState, IntermediateState},
	local,
};
use primitive_types::H256;
use serde::Deserialize;
use sp_consensus_beefy::{
	ecdsa_crypto::Signature, mmr::MmrLeaf, Commitment, VersionedFinalityProof,
};
use sp_runtime::{generic::Header, traits::BlakeTwo256};
use std::{env, path::PathBuf, str::FromStr};
use subxt::{
	config::{
		polkadot::PolkadotExtrinsicParams,
		substrate::{SubstrateExtrinsicParams, SubstrateHeader},
		Hasher, WithExtrinsicParams,
	},
	rpc::Subscription,
	rpc_params,
	utils::{AccountId32, MultiAddress, MultiSignature},
	PolkadotConfig,
};

type Hyperbridge =
	WithExtrinsicParams<HyperbridgeConfig, PolkadotExtrinsicParams<HyperbridgeConfig>>;

pub struct HyperbridgeConfig {}

#[derive(Debug, Clone, Copy, PartialEq, Eq, Encode)]
pub struct Keccak256;

impl Hasher for Keccak256 {
	type Output = H256;
	fn hash(s: &[u8]) -> Self::Output {
		sp_core::keccak_256(s).into()
	}
}

impl subxt::Config for HyperbridgeConfig {
	type Hash = H256;
	type AccountId = AccountId32;
	type Address = MultiAddress<Self::AccountId, u32>;
	type Signature = MultiSignature;
	type Hasher = Keccak256;
	type Header = SubstrateHeader<u32, Keccak256>;
	type ExtrinsicParams = SubstrateExtrinsicParams<Self>;
}

fn default_para_id() -> u32 {
	2000
}
fn activation_block() -> u32 {
	0
}
fn default_relay_ws_url() -> String {
	"ws://127.0.0.1:9922".to_string()
}
fn default_para_ws_url() -> String {
	"ws://127.0.0.1:9990".to_string()
}
#[derive(Deserialize, Debug)]
struct Config {
	#[serde(default = "default_relay_ws_url")]
	relay_ws_url: String,
	#[serde(default = "default_para_ws_url")]
	para_ws_url: String,
	#[serde(default = "default_para_id")]
	para_id: u32,
	#[serde(default = "activation_block")]
	activation_block: u32,
}

#[tokio::test(flavor = "multi_thread")]
#[ignore]
async fn beefy_consensus_client_test() -> Result<(), anyhow::Error> {
	// first compile the project.
	let base_dir = env::current_dir()?.parent().unwrap().display().to_string();
	let mut runner = Runner::new(PathBuf::from(&base_dir));
	let mut contract = runner.deploy("BeefyConsensusClientTest").await;
	let config = envy::from_env::<Config>()?;

	let Config { relay_ws_url, para_ws_url, para_id, activation_block } = config;
	let relay = subxt_utils::client::ws_client::<PolkadotConfig>(&relay_ws_url, u32::MAX).await?;
	let para = subxt_utils::client::ws_client::<Hyperbridge>(&para_ws_url, u32::MAX).await?;

	para.blocks()
		.subscribe_best()
		.await
		.unwrap()
		.skip_while(|result| {
			futures::future::ready({
				match result {
					Ok(block) => block.number() < 5,
					Err(_) => false,
				}
			})
		})
		.take(1)
		.collect::<Vec<_>>()
		.await;

	println!("Parachains Onboarded");

	let prover =
		Prover { beefy_activation_block: activation_block, relay, para, para_ids: vec![para_id] };
	let initial_state = prover.get_initial_consensus_state().await?;
	let consensus_state: BeefyConsensusState = initial_state.into();
	let subscription: Subscription<String> = prover
		.relay
		.rpc()
		.subscribe(
			"beefy_subscribeJustifications",
			rpc_params![],
			"beefy_unsubscribeJustifications",
		)
		.await?;

	let mut subscription_stream = subscription.take(10).enumerate();
	while let Some((_count, Ok(commitment))) = subscription_stream.next().await {
		let commitment: sp_core::Bytes = FromStr::from_str(&commitment)?;
		let VersionedFinalityProof::V1(signed_commitment) =
			VersionedFinalityProof::<u32, Signature>::decode(&mut &*commitment)?;

		match signed_commitment.commitment.validator_set_id {
			id if id < consensus_state.current_authority_set.id.as_u64() => {
				// If validator set id of signed commitment is less than current validator set id we
				// have Then commitment is outdated and we skip it.
				println!(
                    "Skipping outdated commitment \n Received signed commitmment with validator_set_id: {:?}\n Current authority set id: {:#?}\n Next authority set id: {:?}\n",
                    signed_commitment.commitment.validator_set_id, consensus_state.current_authority_set.id, consensus_state.current_authority_set.id
                );
				continue;
			},
			_ => {},
		};

		let consensus_proof: BeefyConsensusProof =
			prover.consensus_proof(signed_commitment.clone()).await?.into();

		if consensus_proof.relay.signed_commitment.commitment.block_number ==
			consensus_state.latest_height
		{
			continue;
		}

		let (new_state, intermediates) = contract
			.call::<_, (bytes::Bytes, IntermediateState)>(
				"VerifyV1",
				(
					Token::Bytes(consensus_state.clone().encode()),
					Token::Bytes(consensus_proof.encode()),
				),
			)
			.await?;

		let debug_intermediate: local::IntermediateState = intermediates.into();
		dbg!(&debug_intermediate);

		{
			let debug_consensus_state: ConsensusState =
				BeefyConsensusState::decode(new_state)?.into();
			dbg!(&debug_consensus_state);
		}
	}

	Ok(())
}

#[tokio::test(flavor = "multi_thread")]
async fn test_decode_encode() -> Result<(), anyhow::Error> {
	let bytes = hex!("01046d68801fdfe2349f26eebc73a416576cad2004a13bcc355963a56d09968105a4957fb019845b014605000000000000cc7cfdd6ea4d7beff67fd1dd92e4fcc7d2d47f7b9e1bfba3ecbe7f2f37fb7bf79e2d6f4eb2e3bdecfd5e1f3e5ff76f0b47e73b00900100002d04882dd1ceddc71df306da74807eb7cf569980b6e7ad7ce7e9e07b90c367de034b3f59ba1d80ac2aea07657bd9d5510a5c4c2259b69615b00b3ef4f56f2d5934b7007f79b8a3b6ee4c53ac5f41f6fcf45a00db54e810a877a7e6f875fa98dd436ab10df5c66f5c1c66101e64f3264564540c46bd40e5a46a392cf6ed99cb62390c6600c6f874ac55cfb67f006c80bfd378f61eb4422c167930a03510af23a56212e45b45515c3aad2e7e4d1c32fde99dd03e4c48bcef40177b6111eec03c39744096ed01a36d825b4a472e495db45ec4947b1d46d43239ce93527d2c8abf1349c9c452993afba669cb4a020ed3e3b58c8042e3ce5b5a2fcb14bf3dd039a4c20a4b41d37c01918b33ca8d459c7addec983261ef536ae353078d619b4e1e1913ff3ec04bd031418ad48ab73ff8d222dc1c7eeebf11e5b6905c8257b0be5f6ecf8ef57defe455010da0f7f469ba0112e49e3cf0e3ca5464b0c98fad90f0d0d72b0ab2ed108b985d320c2b89efe171edec94a2a6962f1a8f7bacdc2d395ecd9404827706626626dd00b60555e5787ef3a8b6cbed4be28385c89a5b560b77663796f65282f3efcfd0f024bec42bf5a80c83b296e1b31a5d9b090a3c6ffaab8ef1d0ba184e9f420f2737007db5d007465dc09c11a940ca0834d2559beb7e0dd12696466c3616a75a1520d670b6c5c8cefaf7d58b28f47a29161c95628b439000e2824486fe6fe194a0c4df0054e4fe9a8b738a1ccedafbbdc3737b03c61196c96ec5a1d79142c2522ca3763a4b29a1834ef45ee60d5d8b1bed02db246624286c313f1d69774d64d1a3deb85800962fd90edcb1b8d3b917f46240265e976dda188ebfbabb71960beb03a517478f0218c2420a402fc48b4c5b64ca9193bf8b7490613f49a48a62233fa2ac2a24cd012e56d59247d30843faed1f383f8bac3261890695ca7acf4065d48334d26ba9b157bf7531eb03ab71b624e90daacb828a30f7ea5b318f34c030ea832b19ed3b1901c6a9eefe823f511d3d2cebc8231cb52e93ee7a428e8bb3236152433c62760f7f68990045f16c2ab1303205e35f978aaf3dda6ff404a240fc33bdf998bd2f48dc00463a1c275b467108d780dea4afe135cb64f444e1484d27f2e11bffeb43627ab36ba35a38d04a9270153ca9adbc0b7bf469927c37789a50c7a286ed9d34c88df2007b7088ffc58d944d5b1a53ca85084327ad3d5d18946be9f01222bd3ec7a6da6810a5b0e8d9d1ebf59952510162f2e897c5a4d27309270b418f8967f7a62db29a00f54fe823ad94181fe19de25df2b2cdbc57e1e88151434a2876c9e0d220082a3c5709dd179226cb58c2364667b19db87502daf0d33d27b3e5aff8f3f94cdfb16601995785cf37dfa0ebfbdb33cedfbec298b29c133450bfe83162c295b4d85bf14f418e4ab5ef20772586150edca5ed07451e4d5ad77b4ddf28ea3b7a6b3727c58a01447713c88da745627783fda9ce260e0d88fedfb9352e48a2bda7284d2bd313177042f9cc63bce7eec0e829860c131b16701b6e81a14f64cee612ef6dcc0c72ad0097e5c07577f93d383381b6f17352251523f4dbeea42bd9c1747ae05ee75cbc646296390d7b711d55b2c44223c111c6794c08ed160a8741a3ff7649eedf0c659100d534040053d566380c0960c7ed2443c0b973f13ec1e2b2783b09f1501a5cad695db37dd95b2b19528b4258f85501da37fe0dc0ecf60e30cdab80ff9a93c46f60015ecc26ede99c99f2b16a12d63db7d9f15bf12b83f326f3b241f76a43b76df39b57097de2b508c9408612a1d8584734c00ab16ad7ca304ef76c7a4d3fa7f5147301b7293b1932be7ed5505148a87d81d1c940fbb3610b029460aab465a579e97e582e714c1e92b85b861ceedfd124b91228ffa7f830637a97db5ceba0be90bc833e012b1ab7990003e2bd18cb9a36f9167cefca09c1e077f47da1d10d9eb799474da42ac6b3ed7291fa4cc4fb41c335329344a91b18eead4b4e681369b6f4f9830cbe003c5fa7280d99ddb92177206d07fa7dfb0e322e4ce7c546845313479c84a9eb4a4fc8524f0f4a30855c38d1dd440733092eb844b29cfa86985fa0f2df38a317eb01add91213ddb2639a2f9ed5eb8bec970b87c09fa4914d9e4a82458c3467d5ce04185494f39f35162ce28f780ca8bb89631b0b938d583235aec4b66d393b0a62c0002cc2f221dab284bd1ddf90fb2c915640b0a209dc493e71ebdad1d125d2baa99c38d1fa405fbe5dbed763a6f048dc327548ae28089b2c4c9a302d640664b56c01018becbc84ebbd15b3aa0ef16d94d7437262767dfbf3807ee83ab21b13b57d613d25b320b428e8f6f831f3ae0efed57d67983b4b943fb1ee66408a2f71a7a5028700145d02ae4f083628de0ba4710c262bab0268ca983af49f6cd82735fba7b057161d9731d6ba27cf4228b50c01d0471ce61b533aa1e84b02b454927fe72596853e004a4a3e49d23d525d7df811206c494e93ad72b6657736c222ca7b0522e6e0f25f5b69feaacbe57eb4e343cdfcd6376e9b0d8a281d530be2cc26ea3011b9f229e10174e8b97d6fce62800956b487571988c84bfba0acd992be21c84fafbeec6cb07068df15e7cf2c88d0d588325a072a3eab1430af0b8be46733fdab2a9d256818940011329427fb3f8a32ebd668bbf32867d9671ca311a1d0aea046fb5078c326a91851dbc94d16b430663e999fc2f3e22053cb113dabf577519437255d3fd422d37d012c487a97c640396b68598af094532c05382e144a579f409883c1e25ad64937d435527b57a375a85d9958468305e4348fe5c1f32c4ecf1365668a9a825a55cc480169dd9d7b58fea8abd4c7f120b6855d3b61993742973d9156d9ea42c3b94258d84a0f09eb8aa87c3dcbf3dfbb335101c6c352fe7140cd7b16aa6960454e9e6cad006f8d4c748779ef949f24154a74909cb4bd21b29adf4ba7c72cfb90ce6f13ff4f459ec71f8f119123389949acb25d72f3ae4300065b4c75c18433bdb8e2bb8113003ce830d38da32960935ff884c18f47720d548f954ad24e18c2f43a0bec99fb5340fb292225b692c513fd892d8bb3785672ec3f369195817ced52c2e42a9d8b70004e7113922645586a2a3eb8fac568a10e75aff1df2d604b76472056a2a0c2728b69411ffa81ca35fcbaa7b6e971f229f769fb51d6f4567699a47e15870fc7199a015d64d045bd49bc1700d8c92f1417a5c72b35b7d00bb5e70c9896b288c4d79ac35b28c489f99f45f37c8d14d6e8a8b3f5f83c839a5926a7ee0fcf19aab141bc9c00a93545e760bc92d662e5718cde4aa021edf5ceedc72627b95fb3a7aa857f2c0b71e5574c3678ae0da84309bb5f6d19740ff61051182565c16ff5f1f1bc0d6d7d005593eb86c7790370aec7b1a0ef6661b215e27ba50c187633c376cf83ffcf40d20b414876bf2b762ba1f406c3eb3e8b981701a0dc02ada08cdb280abd0caa976100139b1bbc90e34838d6232b003a44b546e0d13cabd902335e2acf10e40405381000731548afdc00c8c8afd8a619a26305cf66bb53759db3fb30290639f0f08491017f67d6656c0a987fbec154b5153b78b85a8446e6c56b7b40664388cdd80031871c808bd9cda54dddab026421d0b8badd775a7a7efb22eb5e4f33de6a0a34c073012fe89a7442e66f481f0d9243e817cf6f75a8d429fe5ebb84358b54157412c0b70ee0224ac236a2f8d447fe9691cc724e4e0c8a3fac79be8320f9f9135bb676f3007feeaa56f6670d446c4eede3e2e475d085b920aae98b0b56c4ce812d9a6a8bef42bc39ae0c11f1167fe2cf357df5ebe7688f0248307dc71946676bac0ba70e6a008d5c90d610dc3ad7c65375e4b7a5599a76f938c2706f7c8588bbe36b092efd0d6a4a5989c96b0b449271213fddf31fb3c204640ae59da2382facf171fe1381bb006c6ee57a62ed271b5459a9fb836feab20ff9745930ab56d9d03e25db27ebcf2a5d1f80a478a7b4e0c7ef01e82b248f938847be675514611f899abc74faf7a3e700d26bba1a391bd2d91b1cf69b91f067934c8d15ce66365d005ddc3d0bcc54bca4505ba807519786db82b71baec40d7fb285a53ab738a8be9e3ab7b94df56381b3001e1f2c81d59913887769ac2ea099e06a4f22017ed9d846fd6392be6184a332ad184d911d76c652ec9c0ff07f2511d1c8d65485577b0c052a5162a74bc932a77500ce5ec1283ddf8463f7f65742782d89997d83142583fc09b38f2c19c3582d24e613bf62cdb4a01dd8ba516d75074b680c8d6a0aeb2d896638b6c333b53c30998700d8414a0f5123ede564771838b9e659e4280dceebc1167e38b4dfc69fc7a9af7c77e840f32774d9ddec8ff42292472e2be7d263d6eeb14b8ad35cbd7410b3cc340090782ecd89259dce1a1271abed595c4dc84c7c058d5a1746750f6cc9998f55b2758a0da5384562843299d527cb210fea6d463d85f540e19a3fae29404e2b76b80040a30df63ccda8bb7081350f057bf0f1f0d2efbd9ab47423cfa66f8e48e0ac0e47fb9cfaccd9907689ccdf8c08ea7489751aa355a51ec46cab277d88bcc1fe820081c618641f7b5f04f0b2b11c108727e9ab309c8093503cf06345483dc2012ec93b20e2d107e36eee4489188f4d1caea5e24611ff68a0f3b46523e8a1491b6fda00222bf4132c6a4b5825ec4274dd3d13540baae6018c483a6eb2bbcc06f1370cc43903abfc09abf6f2706863291d93d92438d8f370472c94d17c7cbc77abb0b532005333b0fd4a5a1e3bdfc5b0e53f53be43d90ba0e6b9ca6fa91152c37c75b2a7af5aa50c88bb5b02f8b1bee45a9e5bd6c27b62a37929563d61bef44952046fff5c012b7e9a6053d0aacc905142421eeb65a72c58cc94e9972e97ffbf18bb113c4ee762b970d39bfb9342cbdbe6c2ef533c571f9fda9f3f77b979c7e0c81ace4484d80051b78327d6b870c4783cdaee56e938d59f31b7f462040219836c54176d33e3d359201ea4a727f1aaf3ab6cfb16b6d9109254414d8317a41c0e49ae1c10c7d3130070b17f623b5aa20d4a3c0bc3fc3e9b828604c8055af58dc02de6270fab673ce435a5418bcb45d8ba2150e7aa4e70392ad36b9c26f5d184239233578fbbcf23e000dc6aeaae7866fbb763268cb6e13d09edd61491d87a18cfb6a4fae52f1acadbe400f5f35077a673b8f7234f6090e853068ab63c031c31fddc456d2ec6b92e0020006c8030cd22c6de3d54d34dbf1dfd2317b0576e48307d5d92347bc7d6824a4bf25f026d21f6e52c6824271e0de3abc6a9443bcf75b837a230da24cdd96360641001791b2b50620d29634baaef8ae34ec0671cbecbc3305edd9703a7777ec1ae2f47751bba005a5ab05804931c3569f60af31fdcd6cadccf87a684f6403a53961548000b71732c7533d3b6254635fe457bf22b3281311d327a251ecfbe09ee6ec0357b617b6e9b930ace9400369b1a1df022930e5081cf23d864eab544139ded04eec400299a5c4a58640b86b385fc7fea7fd59b91eb0558b297125ca6ade461ff5e4df662ba23edc7470b230518e5a56419956767bf63fa74b15eda638f544d867aa8d501fdd8396033be3f8f2e12a673c5be03b146927937351cba14a313d8f7ffae3e910d94f0b05c360d662be68670127120478d1c0aa14909fa37bd293138c1c4c473003c387c3e647c388bbe61ac8672fffa1ee384f54bd81c0887585684d349433a507d74cea9ad70d9159cc86fac6faa9d0ebb340f1beb7ad8f4f467ebff7a78d3ff016d16baf7aa167ac2283605740d9f1b0c634d9cbfdf5cb70994f1de9ff428dbb2276991a0b3b4699d1227a7b6973d901cf4d82ea63b3c1ea56f447da0320719dc0102ec1df15ad690a43ec0ea224a77f0d256118d9e58d0ee3abc7c470963e61216163d1effc0e2c604857b9e677e4bc61310f27f739c4fa93b78ba47d99fc28b2f0006cc5f859147761e07845c31432fb30ded21f7754bfd7dbb9bfe05a34f8a475904e85647e61134b3c2d9ebe9cf3a4d2fbe09de7cc3cb148832f51575eba03eca001e914fa87799b175e2c3739b7e5967ac85dc56042e26999ec1068efc118429d9740297332b9845f7df4b120794cd3e5828cd82e3c8a96f489c326c8e079d571f0013a2389e9e19c1463c70eeeeb2a6e4b2997615243385e7421edee157642e43014259e9ccaf758f443a67ffcf3cff9a349fa17348904d7806f163221c23ed793101b0e7d18d56f4070f7b10cf681e031d2e3dd32dcd0ed4f3790c48e2ea627ba56715a2400109fd056b168cee35493d5f95ebf40de080a489df5f990b8a11c4e66000bb822412d99d462d655c9fb906e1ff50e9f14fb1ccf50a24380e76e93011521923dbfa9914caed087c92e147a51c888e006f46dd4ffe4c88d83cb001050d979601a95f9f86400f6267a4e48e6f8d30afd05270e787ad1f10639afec27edc28e88158a55844af4356a605a5e5dffe08ce3a810bc7078ac1c8ac0193360db64272f500ad6efe4925cfe996b9c1f4596d294822caf2aa9df46aad8613988f6c9de0a8283e0cdae5f090997a6df62bb86942187fb94ba9cc7ed5fadd80901c02d1cb114100a1246a1f76b46a61cd9d8367fbca42b34693efb606e2cdb0a67758e7ad1f9ba052efd5670b48b458b21741a3889bbe05a1e6a4ce47b869dc16b92f1c6770ba00015f7b369c5db64b81c0311e415221b223aee77c68ee4adedddb5bbeed41a148d263dd6e72abc209ab5ed06819211f39ed49c53642a751dffec32153941a1e3e8e01ec21f792f505bd5fcf896b928db28c4920f818c25e2e54d415513d8941465caf43b04eb61a6ddc60107738b5be8153d539f65ad423c77c44850674b780cd70a401e2a47e9801da1f2204d8cbfaece5bd63dedbb158d5d661f3c813a5dfde7f25f71be3b437ca6e669a798f61ba18cd257c99732321c6251a53995d55813b2ae53401a725adf5ec2fc02cc922c4ca5ec9d9ef0b1f819981eab4ebda36de34b8c59f9c4591a1c90f44382c670d5205d13f4abd48b0eb54d5208ed1df4d5516f529c04d0193ac55706528a68e29dead04dd1e0caddda9cec62fb03d5c331fe6087d5e31370320c46f12915cee0098f1fc6ab769e696241a20e59d92209307452f63595ded003b4e22222d0b785cada3766c2d9b01a65936e6a3ac0102694d3f87eec7028e4054941b5e4023cffa2183517d15f28e58f93efb66899388fcac1e8508b3d05d0a015ef19c3d681a5382c019fb86596c489be104ff94ea938bf175d6fc650ea1b32f64ba29dfe4d97cf560334a9f1ec30484a5345486a0df6f47b176933a51a4ab15017a4d576b0267fc2d7dce1bbcbe400c26892ecbdec5e730987ae44fbc1b1b556a017b0db0078901841b85b4b62cc06b355e7ef683d74e78879558c03e1dca33e101647a1eec0ad73a3c9e1c10df4b708d874ab03d024e225249b2116ef0b9274c09214d11ba5d38d2858a89872a0b9b94b4bb57ba6c8f01883e6629d5b5f7159af8016c3ecb11abee19a17937dca8af02ac296f9dc3713a444953ea58f575cf90eb876f368e66919bd762fd54015d4aa300c253411ff4b2d5aaff2488e9c13e2a63370075c7a065c753c4b636e19bd3a7d96bfca08928d4b6b5e7ca56540244e85d45ef416afca0f5a6a3ce56d86838de4920e13e198a59c16afcf74650a56d7076b2f7016f395b71867f64b8152cb2a4efaf702dd6a211d68db87e0c2ae116cdc88b6aad3ca357210b9ec1e7005deec9ed2ca7ce38c5b79aeb01cfa3aa1a7e59a805a71800ae24a1598227280793fb039d99dad66e78f80b683c8edccb7c0b6a7d5836589206d08f10d2f6b49552606ac2e51fb18f04aab5e7aafb670d9792a4f1d3a7e69b0105eabfda12bfd22b781ed9914e32a7fd44e40884d1edac7c9a31aff773ee5fd4176b1053375b79e5fce3e102f7cd3e8007130b8f2dd15258ab03eefc097419ee0054d9728c091013fbfd047df795554ec9f801c5853a6774dded19997af7ae13a2233c6d10ea6f0cf575ebb8062df615c27f7eddf0862c87e91934893f52e762ba004fec9e2f68f31ebce3a3dc0486c841167df2fbb29d9f6e2f834fee2b8a0f1b8f2b9d7f56b31a5f50218bda2d618b878ecdcac6b4c14bb179bb93e1cf6bf5a81f0141c3c939514012ab932c6ba6c3fa413d58d4a313a1cfe1ec74df475fb3cc6a585d9a3bf79289471ccae2a2389a0eea5c5fe4ebe27aba3803c58358bd3c73f7dc00f6ef9fd75071d0672a347a10f779d5a2e3a642452a6be19e7c85f670af42c85544544785947d2ed17c9d0d214c94f60d1cd0d0817b63d9b52be719317e428aff01ee8833e5febbfa3e920fcc4b958e5221d8e707b45404bf5e7c5d0d495d706bc45047c92db2c1b00ac78385bbb4b0f508a4fa05679b813d6d568c5234980889820148578e10526612e789266d60d4c7ed7f369a9acd4ddcd0bbfa0fc73034c9d50139ae3780b3f066c5e0f442a7e2fc0b2f0f3fa7dc7cdae208ede9b2ffc70080e50155095a2722a4b57d8461b321a97ff914cdaa3f81afcaeec5f4ade248fc4725ec66b8d7c455b704a97157a4f560d13fd51cc436a80ac31ba8252a5706f7065ec90035e2596033e8613b907a3a65d366ae5e5ed68f0811064267da9069f9375c47e1735b6b40d82a052bd6f4a58b540de0f92aafaebd158af5a67bb24fa1b51ac10101e48b647a4d0cc73b234d11edccd6e531ddd903f228808b7243bc0d84354f68a13b508395e2a7f14b6f0e28e17f618c3c111d5ce137585592f19cf869fff594fd014a03a023add51cb1183a5551693502e3ed447d7fa01f07c2378a0c892972fe22731497a66c1a0dbb82cdf5d9630638f76f874b504b83cf4ce02c5f34026235ca0078715d5e3982d2a347dec82d3d19c68086348862d65b8beb83901e55e8a4e15a56bb58acfae71e69f489e9b9a65267237020d45595db3dad097fedd0e096c08c018946c557696d32d3956ac5bac2599b99cd01e899b3da1cdd0a08febaaace8e572a90ae75f97869b9890efd5a471d1c07439fc679dd9106302faec29242b5832001ac73788a59e76dff489d0bde3d3abe3e4ff9af572298a43d8c1375312f84b9c76a43a75c57c0b1df2b7a5760590d52706f22ae56f9d62ea36c7f021738c9f55700cbeca3e0842ac1e6541cb40af27de94de0666af3d72a6ca89aca67fe3a055df471d215d00170390a6b4cedd59216cbbcc7685b917580ea320ae4ebbbe4c5171301a2875557dfbd39880a0c7dc286f932e2a828e792ad2e987c23d0ae25de776b4075ca1e7902490c1d7d3eaedaab8acbc863510a961599ff81001c34c07748f9000164fd4ac9d617ae53db87a07e0f6b11d0b1691ec6cea76d1dfbe0804136ebaaec517d8e450c4feccc9beb7c10e3fca5d96bc4c4e8cdc747e87097842151c0c6ca006e08490bf8e42adbe26198437c0d9b985eb97bc741817d8a306790f7a846b4c155178ffe8d7317cd89779b375ca39887dbc89f71179659f56b753f4c6020a82c0094f0bf67a7d662ca422cdc3c9692c60cdd21ef00f8e1d2b86632300515668642542e2ab6e4bbdff83419199d33d0b8d8756bd34a707b0aa04bb3b43e19283a3301fb7da59bc0d2ab8d73838bd272f8ea8267a54352de7468cd1222e811adb249a66372434e6e9fb24c08c8126dd01c6a0146419233eb1306b0aa95352cd3aa901e01388dd09f441ce971a8b85de2a95bfe93f2781b91af2af5c9bbc5830c67532b08290d4ca62dc319ae66ed5fe74e924b0b79ef2dbd188e13e417977878a9cd834c002b817886d2b2a965e017d1fdd512b83798bc65f06791fb9b2479658c4c1a773638248fbd33706bb7a7561a7582af8699a7969b6d6fa334bb3dc4b7abe7096bd301020b3313bdbfbdf43d82d74b31e3492cf83d73d1c7e2e1b268b7c1383b8bac0856a81f3ea716648920a2ca17e29ba81897e7b5088c5e44f8bc6b55c1094b7f3d001fa464dbc277841debcdc99be0630db09adf778c48c661d7ecf268721576a15c0c57544fa20a62c8a84789e75e2be615bffbbebac9fb5b09fbccceffa1b4f0b4006b097f82d29fd58ec2c0a9431989c3f898c3ac131e7d3275c494d43f2827a64e7897bbdbed4f107a87b744f53335ba289d23ce2729e94ed5905843ed8656450700d8e5f4cb3325b9dc2d34f6b4385d9b141812de3b872e3e9a2594a4ce77173a315bb00dd1b8c23c5f9db4c1eed87fbf2aff6ff06383cf04aeb3cfc92b331541a30013fff10b979b927914d141664dfa6d5188e891205963368f6f9d03698b1e5e7e40e5ed4a319a20e794a3c6c57dc0d3c898beb68c8c9f8054593b4ac8fecebc8001bbb6284af732a036ad4e5d52a79134e8c6c2eb1cababd41d25c6c6a89257d7e25c529906991af079374f912ad3f933502dbe1555ad2c5e4d67a0ed07da87e79000263e956307e80221c3ebc6c8a67078233ab8a6b9f1ca5923d8f64f05612e269b58783487e0585fe46c0e4f8d1c56f7bcb988c288e6fa2ae5e6a03694fb5041eb00651ee38e566a5ce042e3077bcd2cac1efa7e654395c22f18cbecee8027704c0d795a3c7a59e5c053237b56af5ae440e9ac9f4dc8773ba95a9ec01fa8bd6c1abb01e8895247f1259b1c338a39ebe2c11866084b34d65cb4241a5eb010b9072322d74a89df98d01e5362eef7a689fc93c9b13cd23fd1106519924750b9031f8ecfff01fe589ddde01690ad57cff21e226e0a37575708e8ab5bdd5875c28c47d83f4bec293a46d58783853872ce287c42d3663ab0435f87e8a715b6dd9a0fbe6343a3df017edd516a95a05b4fc80f215b77c824a9a7015115456c0d7e03227444f7abd10c35a21d7b2120a4f0115597dbd77123e4ffd138402a5ebfed69b3e9b6bf2ec37800b04f6ef79497d0b3bcd2e45e061bca5e9010fb313248318cd57f1e6d556f4f9c46825ce48df006fdd8603bffeb0af0e78e2f6d921ee9c470dac641e6e213f16200bdb2866e951b3e1770e1a6aba50cec68305e5878b404e89da3f131d93ee73bc5770010b4b1c796002faa3a5400ec1f013ed6d0ca8982cdacb13b5637691c5ca1014e2f23fa217bc4dbdfaa4f0901b282021ba1e614f9e0129746bbe758520672ad2ec9130ce0b307e571093ec1a1cd08758ba6be4c1a791cd0b6cb214053d16606006aa610774702171714e4d2b8b02e82761fd12411419bf3e67af67b6ee87ec322497472c0b7e4d13111f9eaff8b0d6f0a3337d8d0ab83c73ece9a902b2211771e01c38d98af9339a7d4a8cc475a73b3e5d592837492550765a184ef8bfc5c67c8226536349540e0051124890f7d58166adfe13b9cb6f4efeecac55fd2709b17129700e3aaa2025954371517bf0948126c0a97e4ba16a68cda398f8125ebf4a113df0010e8bcd1c5f7c2e4e3c9f83f208d25cf47451346b0da5f37bac470bae39dff060038679c29253a9d33fd47c793292f54f34fd51d41f8fbf688b3a5bd9ea4c656e008c302107da46e2b665cce767e62e96f184884882131c30443aaa1a342946e4b002be6810b41ebc17301b9115fec727f5850ede6d9dc032a55a68d4d1615752e30041489dd78b9e436f1006786cde797c1660bc2c4a174748400957012b0c154a6016551b165727cd1caa12a8fad23c338640911dfc5b71da74e575e78b30d7a3be510b30900f4ba598d578eb39e96eb1944dc7bbad597fe2186116e92a5e3a2e2f300a7eecc7fbb7683d5c33bbd2989f534997a30cb91695eff4cc80e863b721c943051c3dbbd4cddf768e73ff6e957f051e3e772dfe3d9c88024a261e28221e42360004eb456fb410d56192441d7042dbd0aa5863cc264cb7192f52776640029059bae4b683393aa7aff240491ef19df00deb2ccfd88dc1ae7ff39312c57c42441aaa10132c6b449640e98ac013c2012871a0b5832d78dfd50dfaf7ed8108346c2f9ae7542e59413e3cc9fb72a911b8cbd5f2a8390f9f9e5a2c8c2655a5488b8506d7901019f2d3ddfa562aac516a324d7a92f2e88ef70224ac741d373fd767ab8c763e6700c0827206dabf31b310dc543f38a1c92cef59ed429bdda3c7d4205e941cf409900109945969e9105f39b8479e338181642b7d945d472ac741803c1f9706b2f0b66508c3e5eb340de40bf5a811a42424c0f635a8345cc044d7bb26c394b94435df201ece756843ef875faea39cdf779f68b99577642b90adaee69c3de0381f70b2c6135d638753319580b87b37fd608a62f83ec5386b45bd60d3b9692f449eb38ca0b00c37e4144274f9bf92ccceb88b3c73ce0df8f543ca2a53df8b87ad1ee7908ed5b3f95fa8d5f85bbefbfee86ec3c2a5ff7cd888ad3f0d4e1cda21c114ffa8af3070037c22be570b4296257c28e665e0fd9334d1231cc106df60e7840997a57d2d0286a98e2dbbd8fd96c041d9d22ad80a7ed5670b2e43d04217105f5fb8e85253427016781002ad994ea31716656422798abe4ca93691315256ed6cd61a8a43395ecfa0ecb47b6687f86885361a066285c6d610a024f5aeafe3a8ee0672c28b202815e01bbe20e1632a74be45402ba0e88a24f8e02c866807005f36828bad4d37bb851cc35242c68cc71b367e0acd1ad732a6a0447e5ed1216f1099889d90d2857bbe3b001fee257166ed614fd96ef705f4dc62c45df774a4ced8a1cc565611d3ec425de2265f50d7e9959b8619486838e2b2caac9bfb2bde90bceaa4ba3b96c450cec9df100e2994144cf3f03c8ed056e926f03b74cda8ff1fb9e7bda4c575cbb8e504723c940b628074905ebce3644bab9e16da21b727673436d6e89bda78d3d83d22832c700e71cef82a24116e0be5812f493d293946b1690199e320c02c11b239580a07c8648ca6e16b65982353d14ef8b0fd564e39ee9aa136d662c89715fdbe5404bc9d30157ccafda990ca2efa293e3f01057c0bd4bec9181745ff0d8183bbe78d8f220006c943a32b997dbc8c178d6b6e0d5a2a9aa63fa2d01578202200b9eeaa8f33dbd0090430e7885344021ed16dd79406cb27e6a4787dcedd9bc8d804d06163db747c779a322a4f24b906f2a0eb179335c761b777057cefa1772abb7d751a124b8631c011bb890d9ff692353dc921ad25e036fe6fb0be2b7014069d70098b86095c90a8014832d93e6cfcc11eb76bda0cfae645d9d782f82c8f1470e65f272fc1b5c91ca00bb0a5ef4570b09e0aeb25e34fa39672339c369fc397850a8a1a1efc542c959933b00c91b08875ada35d11746b014e29454d62a40033cbc9105dd56e5247b46e300acc73b470cbf1cef6caaf60705b1d2f0a0a530b221ef3c2fb469382c7d8981295d138c43ad98319be0141f59028be659b57b8df919c4c5a42f0a92eabfaff34500aeb0af176949c48c15b27e42c730b60e043e04d6d1d7e99b1392103fc98351774d36cd20bd8af90738cbfad8d9ddd2b5f8ecf50de7a7a68e0af3327c134fd6a500304bd275153b6345d3c5216e5f9a032ac6102c0fd7288fe955e861d938a65dd004c6928da1a416160d8b8ebfb3e424db158e38573b200c71680ae70f5954ee5f0090ae25773114a164d1fab64ca8f0b7f6152b334e25ba6bb96f164b78ddfc58442a835d082d1347337244760c55651ea2387277970689bd4012e8a9e3e701396001ff2c4e6d6ad26a6e584f275fea8beb50488caae608e38e83ed7604adf89472ec3ae9fb5f60fd3806a225c4c78cf1092bf5744aef73c129cd5bdfdf0313376779006824b73f7f25dd74a2d1fc1bfe5b808092ad86bb0667be3dd96e544bb24103ec27e13260aac63a1a4db856e83b4cecca6bcc6440c04c5f32d3ee27bb370d943d01f2d8a68f16f3971087be3758b8c0be0ce206cd613b851ea3d3cef1b940c40f3d1cc19d6188e7174366a0e5a231f5b69cc9a48fbb982605fa9481c653fbfd1b610016caef8bf11194de440b8a4e1d17b756ca9de7459e25384f2502d9cd18af4de430469614545607c3ed031096014fde1603d03c35cac4a767bf7cf727b78e95a00087ca7a1a9fb535b09e463ce30c4319d4cefd32e03150f6b01256ac55fbc322b30b2856661a7cb1b0fd2570e70b8b9c7105646a17cb3b64bf4df6cda895e203de00df978d3a0df59e41de596d57d9c892870e21cd4a6a3922f74eb0a3681ffc71593f325d291f8b8c6fef647e216e2b5e5e8470db7b67d6979ce1a64fdf4f0920450128412a8affb05496120fe68376f2fbd20d2a4aaff10f8c8445bd31bd7eb0d85b60ef61738961f21bdd924b9f56278006586f3ba6c32dfeea8f1440da769403b801f6556c3ff4f66622bba93fc708ffd10d19fb1f0bcf9801ada104c92f11833d6d69a4ccf19dfd055cf5c58097228073e9fcb82050511880d43c6e24a7e833aa0001c11f35866eceefd20da02216237fde90784a5c8a02d3578aa01119a855b3dcc323d5f935a6f6387f854715027fdfefe770810add089afbf2009e0b55d5fe7ffd013e82cb9cccaca64295071667e874fbb1652a720bdf1b34b966f61e8153d153750d39dc2fdf3a6de132228808b801e1fc768d60db6957d72c7d898e0e8ccab057003400361cb535cfad6c2ab82c8bc6417783f96c60adda4843278838a9535681307f63af09cb5d6cf64c93f71a81bac7f1f62d863c96f6ef41e82dcb29abf919a70010ecc9ab80d6ea402400d3bf53f104230b926e6dbbb8fecd3afe64412f46024843d3b464417ef81c3b8ab5177adffb21288ffaabc980c65c467d78eabff25ae301950bd0c172cd54945d95fb804c9a63547a6c95151d6bd13f9f78d72d6626447776034b3df723c849da6848306bd85ffadca3c6167a4e5ca00cf83650b935968f01986394dcd7c08c58f7791c85fe3e40e1542e764887f942e40f91a72e95ec2dc8372db2581adcbaa0f07c31a7c6701571a5db2b86672f155f5b89345a47760b2700630b07ccf25dc67f8f3446f51055d85b6d01e2f6e7b1e7c8b4ef045a09ff02b318a066e629585779fe0fc696ed19c7261b30c374c400631a0d017a72b079de9b01e2da4cf75e8f970d320cb9a24a8c405bbdd97b1bff581d8e300bbef737841b7b080e1e75c9faa5035254e774d82fd66b9a736bae2e7cd410a2575b586c33ce3701311a8f5784b207dc4c722df48e34f0d3237a3e82dea23456870107e3462407996b1f1f217715a621b23ca98d289021edb80a5d79c980adfbc52c62c7f5fa6608001a7ae5786070af90cdedece7e9be3c27d5f7f822dd2a9fc7fe76f1798decd8d768a3549714e8ba7b79e4d76411cbf50bf115236c9c6315cf79f40fbbaa0e45240025b1c4a5fab9f795f443aeb13a7d6669929e21b6dbf972a9f2f7f11b8f4ff84a0cb122e1ee16d4a0836ed10f5dd989ef5b4ec9c8232ee9016bc9b386b12cb71101a2c5c94cd00e14ab084d1cd4b9d52208c5ba647dea2299183c3acff3dd49ca594f3f627d8ef28f029b9988ca1f0de622219e2613e093934c69ac9bfe8e6766020193d9bde82e39b6ecfac9f102981cbb779a4082f32b78203c49402090d49cc1e55543496722672b6d5811577c8aeee9305416660b7808bd06e35c929ed39c81c501b416dadb6979f5bd91293629da51f000b414d85742452ac8bccd83b28c6aeef77a7d3e222e9512573302240e55ad661a5fde20c8cbb11b0f0df4a8241f3f106a0070791d5ae6d7d942acbc476fd84c013694f391b413a120c957ba7cb964ac6c122b8d1ae7c11671281198fe496843ce54c7409e538018ce93a1996af38618eb1200932755d5f960d6aeb8f519de44fddde15093bfa3bdadbeab8311df641bdb6c1413547e57adc93ea682c7047c70ff8bfc110c15683fd2f0b38159c156b55502ef013a3718435e53b1749d16a2fe2aeb5b9c1dc2b4322e8059b911fddda3ab187f531ec28315f6c41b56a1981ef8babfa8039204925b19dd34d5efad66c4b589e5170142f4534fe36b4aae06653241b36fac3ad2c352d2742c8ef01d64dbab3033a36b109112446fbc24ce75f931824a68db44b6565d36376cb3b648e790e6ebdd2d8a01bf94059512b96986e088e9534fbd98c4458c2f093d491353fdc5405c441ad10223f08994b38cf4f9bbb9d63ab1bf6e8c3c4560679c007cc389ceb19828e4e3c7006c3f2af0c9c06a26dcb2243989b880da463bcfc1b527623cd1ad93fed0da07354564a346cb653cd76962d62f780cbfb3172685f9c6698665d31c48b9e357afb0015863cce92637ddc83bd8239539d913527342b1eb7634ffae0710650075282b3e1ceb7324c40a4c1187d2be6195aae495ee38875753dbd87213dad31de036eb430075a2efb13313661eb4879365ac3a9bb099eda9488dd644fcd671a8ef2c8e043871557d73d7e30b95422ac2064fb2f742df47dbcdd938aa80b64b66f4988814ee017f9dd0726ffbf522fd18e083a408b0a52536e5d9282edde1d3451a625128c3f2679121dae3cdbbc3dc560aaa8d5481fea1e4d44a8d7c62cacb331f2d4449f96e00ea7440dbc01742d118f9379ca3a9b0e60542a5775944290bfa53d0043ae153bb5551ed6040044b9e68054c2c0478911ad2cf7782588bf0b8c967e2fa6ac19b25000514b79dd72272c6a79062e812e874415d637be87f0688644116417326a04ed366eea16cecfd311399a0da52f32cd3cccafc16b0a37a959844666156122d0bef0186ec92f65376e51bc0198fe4b12d780ac02ccef8761df206952d6224821c76f85def4cb39d871ad354aeccbbbde17c472411d44744ce57636b5473023dbb8c6501ec9682f4ad3806d5e93a28584e3176e285ef196d7d806e17c371182b4e997a456f2b1275f2641e15d118560846ac5d99ad37173dbe55001bba258c375b398a3d01e5107bbffeacdcbe8426a202202247cdbea9d3b6d6f77cf199c0ea00ac3b052874aad8380af8f2e684c1d9e2c21c990cfa1d83c0a2bd285e36e4f9706127583500f9e5d89863a5042462c317823a2e48b1e125704806f57afdae9ad255bc930d787a5ef66f11c5e0932f25e8ba234773ae043cb70670cc7368790461fc345cd99c01ee7691ed6bc2c0191aa623e7989a64cf9ee38debf4e0e3a169dc49e2124b4ce20e1c58adbd476e575374c68497508edea3b03478402f0fe9cffe0ea000ba393a01cd7ce01838b7744df0e94d3c8a86f23087f532ba2552bb818cb8c73eae13a3de46df353d0e52dc4c4dd963f34dfa7fe13f3c1e233485046d6bb4298d057d625800ff21736a78d100d853a340e1e43f0e6cc24726891de19a421d888a6715ed4ad85fc8057eafccf15897c9dbb121e6d83b1eced114c3f504b57588a5f10ee7620f016de3efc60b2ef69f928972e5d032be1e7eb7ad7e1ba56c5445b08fa2e8fa73a348820bdd15d9dc357e58ed22d0e65e76252ddc743f36cdd0f000c99dce08fecd01c3880afb21cdda50e4fc2fedecba3d67f7f3130128a4e764cf6989eda40abf9840288d1ee1cf65a60f7f25a73341bdaed47844790877ed67f80fe67c252fc0e801fda1ed4363dc96db281b8559e88ce92210013dfa0e47e9a240a202ef9cc78bfe499e41afff79e5f6b64df74dc7e1f1da208b471a8e8672166d09c17f9812e2ac01f9097ff2808886d4270a69eb401055e86a8e4b39c7bf866428e0eb099a784cdf22e3da0417fff77b6a19d1f719fe76c1787a31e1f561ed6e0058cf69ab253dbe0145eba99142ee62171fda70b0e618eafa175c52345b037d00f7f87e71080e202168deff6eafc1ee1a1be8d770db53c8f36038b87474dd2df2a74fe83076cf661900a2e5ffc8949fcd0cae9ded62367987e59788ff9105f09a328c33c18689b679033e36e8f2a1b98f875b3a4ff0bf4666de1166f4fc3e08b3dd8fc53b487cf9862e0148439062690f85d447c0df9a92d790a1514897c34bc4fcb34dfb4dc57d65e0d76c91cd2f5765bfe5b886aab7e6a0b7bdfc0bd219beb6ee5ab88ffa2d5cf5341a004c630ab84f67431968a3a263a39284ac612dd7a68b18bdf9078881be428d353f2344459f524102824612f79ea0d52cfddff63d45c9baa06735f4d340de4450c9010210639e5860809ff93fbcf47015bf76fcb27176fe6b8c1dd2c3ae090ce46f3d66a9a3c74bde833c18116d12e9114f1f496f89a54c48a7e9ef74b2a916d7ada80001b7fec0edad123eca3d1470773f782510cabfeaefead3d8f24b3ee42f98ca2342ebc0081883f7b53087e6516251531835070865ad80e73d68e732cb672a0f57015d186ac2af218aa95bd47ed96ac200c5db953a7307a54fee2dd6d81f62b49470379f82172fcb99a638432d15dac605000e4a53f719edabbc692e096cc243e8750133f6a3ebd7659f8ef58e7c65ffcac83440ff453b87f636e229132773e4dc851e7123a9fbcf1a600a908d19f66b082f36beb1eccb53871d77573962ddbfc78c6800152b4cc8c9f08af84261e92db40ccb349a50195ea02f65ee562ee3f47f4a671909ed1467dcfa023a4549402a53d9686030b6907e9e76aec67f564bb93f68ec8d00af2ddda151c27554d1e2b5aab54955a256b93ed27b40ef57a50eb3e4e6e2896c73c450bf7666de7c6c857573ed41faecfc13dc2c42f7d281b21d7b71e65f00020127d8b516843fc38d6db113e1a518d3f536f9f0f8f74b300a7e94b58e13d927ab2a792c9a0695b7e5527a6c423f48c7b10ffec3852f96cd5642be85d71a1608c90137dad21e1b1eda5c5e284f6a56eb26381cd6c9aebaf1cde15f6d5e2356a891691a0ddfb15b382bf9bb3b29441545b2a5755b7262f7a4135a4c2c9dd608b68570013c91cda4ef17570f40ad23707370faac29aa95b0a3ae448a38a66d6ea62492310e8e59b99505b6f67ca0f450ab17aebd1aae08d931791267b8d583b2b4b207580084b0e15bf5f18dc6d186351d6653cb9d10a9b05a93b04983dd0aa43a0a8fc84777edbeafd55bb100602a499bb4a4fb23efe9243467c3b786ddf9e4e6682420a400e0e80f3f688bbe7e679b34049cea289975d3136bab5fb3cf90ad3bf46a8cc79f4d402677d1c4359f27ed05d8a89a01b5cb2c74569d87c8757d2f8a4924647fd4010604539601a54a47063f1b2d77aa92a8be7a7b1e834e740e16ac64f00d69e7a976deb6f39607a441e1bac05cff00ce83b9d06d66e35caeaa25f3929614ee7e6d0075e217d51bad8ab108508d23edd885d7bc790784ed4d1594b04fe8b20cd7e1803711a00176bcf96f251a46788e705c250ad62bddf0529df2e784297ec46536e60024d6767f6d899644468c5d097e56fc3173191a39f126de53e69ee8e916dcd94f3816de13211f469632d92fbacc4ef833869293bdf4eafa9571fbd4a4e9deba0b011b0a0e3c1221ff34813da3f332976e396f8d835edf35833c3b15d89c57ce18eb3c80129ff8c543970493536917647766f9af5b68d2c9e36a2baf0ef7f76f83ca00975192d40ad620a6d517c44f8f3b719f154321edd341c499ab63e34655fe294f306568880e8fb914fc2792eedea77d2d856e82256cf5f63ac5b58d727ac965ce0146b29ddb07db204afd97fa72073f7c2d10ca52679b1676d12b72bb09988e07ed26c2e5ca745d78daa1d3f122fa3c9d80bc4339911116e5094bbb6c24babae96301108a7a415790bccfbf7a75a8017094cc922a65d050dd8ae1867a0376c8b626851d836b7923daede7f32cd6f2132e9f729caa0a0d19177a92f670cb63904c6d6201cbf2284bf3f6d1314b5a1359c3274bcc4554c39f52130d045d6436a42eab79c516fd49b42cde196db2b864299947099c0ab34aaf076905a865adb08ef05ec0960179d1ac7e85d69631e77f66042cf3fbe930ff7efa2b52ebba55e37c58309774be722422beb46017a6a409d9a0175282b83d2804d3c94203b235164ab34e03fb7900eec47575a6ee1aad1d3eb7b035a215e15a12abe903b46602e41f317e58453bf20878e92841444bfa24571822aadcffc2a009925eb06bd627a05cb49de4ba734c01ec3ee7b2014c6de13b9ee61f6e9e4290fb9b67f2d429cf67a2f5f9b9d68510b7265c5e64b01b47c88ad0c98c751cb2253d0a97960caa0927aae77c21ec2aee5d01e979d0fe471b852f1fa8ea3459730666d5aa342b724ad34d6aa2253f20ff08417680e6f8ac0cffa4581bc65495e59f4656a90245b0adcccd5df0c939623bf12d012567b70598311a249326f4bc9dd05de1c780010ac8fc203bf867ad0cfc2c37a51f1152a05b69fb3ab86504d88283c680a336e0c71a9ad902468ccfa8cd77153500a252e4ce039f6a58cffa4270953a60e2ad1bbe1a0aa314c07635c095f5d682cf7b52183118de827e32d2b30f232bae96a7dc8b550908333a99e59916dcf25ff40075129982d0ad3f5a2ce90946fd34bc2904e6073973077cefa95789334affd9c448bd9f1a26577cbf7a100d96d4213d50d7bd7cbe86cd72808ec8df9d8ff7e58301ebb74592765e5427fdcd8829aacee725d8870f2471dc4c048d0927132169446e30eaadd0e8cc04659ff05d72536674e92b05143690979ba48ee8335193f3cc5b007cfe97150341bb5db4aa967c757dcec61fab7419529f68363b1aaebd18ae8a7c15514ac86e9d292daed5d7f74f3773871a13bb406905db20b7b3e1ebc048a250010c6242fdd5f222ee98914241489735a58daf697702920d94a0d761ac47ffddb3454dbb058a92ab6e0f003f539f638d01f92f2673ffc20bcdb05cdaff119a4860008f7db5e98b483fa7360309e289de9ee916bc498af39422266220cf90c545760e53c7bf1c2fd5cc197e55aaa990b6a563da6395a8efedfbcfdc919166c5bbb4a20195ab040d66b2ddd90849610f38eeff103187028b0a626bd722aeb9e33ff981855622f72dcc7f3accc6c16a3a3016d4c0acccd662787d4647490633fdf2dd5aa101498222418aaaf7070bb176772f8e62168cc48731f863809b616d43e68c5e57bb30333df648d2aae861f8c645541ad967996aee4c44c10ea51acca55a57a010790000e037c1a08dfee1d3e61c222af32655a4549de0608fc1d105daf7e7b14347ae0a8e480aab5e4c2bb7ffff7e4e464963d5f60952b165cdd5642fd5670d0a603d019c273710601780bdb61a3a832d4f4ece6f82986b0e18ab6c5cdd44958d2b5a541cdbeddad23a42cd0c1745cae5463473cf0455415c39f37b60083bc172ebef38007e281411c226fee09e46b46625d82be34aa6a5f06598efaa85c6a8bb357577f009522121f11aa3c4b1ac7bebb39e6127f8f728590a6697d6d7a1a0d1cb8d6f260079ef1b6b5ef217ab8344ab571ba989ba77d3d7fdc089531fae518d446cda8fa7046e8096c677e837c0edfe7ab6ada913a64787b3d3d917d23cc2c9e0dfb77b070107dd1b32298a2b7cf62ae01e833e979bccce452091e945ef0e7624f048c486221f3e5172dbd78bbbff61599cf7b1259c413bead0577ce6210190655b0b5dda2f0056f003a7edfdda7c7e8efafaa3bb41c616685c7f2e08f7745d3b19554de8d05e63b33ac21de603d49f717b10fdcada8257477a64771cc294a89aef4f8d3ae60f009b60002ab0f6555b655bfa275a60d48691364a5d1758b52ae2d99ec79459ee2632ceafc54db3c77a92fe34bbc0a91219e17df515a39d0a30a4d0ee9469e9209e00f4e09a14ae2655d47adc9269e14481508b826fb3880e5303aece0fd224cf399170f396271ed6ce97575abd15b6f07f7d361fee2f3c95d7c989c1f14786ed16b900f98f0177280cb65e3875f01f0fec76310a8ca2de80130d0aec7a91a57246234c66341af27df5ff64bc7bcda22047221464a64d1ebeda35db70606f924f92be6301e6ec16eac6ad95d5fb4c96b01a7d81b5a64a13bf809904eecb36b5e16e9f944539681830610feef4d82a0e8495587fd6863a4f036ce15f2a13fc2a7fb1edbdf901a04b53c6f834fcc75ea87612a82ee612a647c0f561ed3f416d3e8cf57857f0895cfc019b3e75e9c61022171a12bca7a7917a4ed8feeee36444a21ff41f547d0c0100c1f8a499d20ccb1c637e21c967efe77cf2808733707e7db0fccd86dee2fe482f471c549dc67a753ee1b0a41904ecbbff919d238ddcd6d47d3e44ed7dec595601568647f222cd14e363f1a5911637239dd09065a368d4ba278fb958774537f8181327a331428fccd72dfd01b8c4e62858586824be629eb3c64cf9b5cf8d6cc3100008f613713d18e0b6582084009115daca0a014e184d07f10a395a6351a68970074b4da5c0af3ebfa432c6732dc5afed8201451ad03fb0f68a384f2aa1628e2131000518852fac88f41f7db7e50798b32cbe2e2d7e4c517942196cda876acf31ce69583a5193f2389387a1edb54dac713d33af0474eb54a977e4a7c74fa677b9710900c052aff3bcb84891b05791bc776ea33fc9e57e780655662949b6fd8429da3274702544c528693db78945bf1f83194194cd29e9ced877609d74c0b2eb49560f84014c35e46fe8ecdb08df8bb536811dc8fd5b24cbeac2af55e59eb72067267bd2fb31d0f3dbabf700ebc6ec2c3f82ac5b5fbdd886e60d046bde472cd3a0be0e9165017ba6b49347758504b9ae225d7bd9828c993ef12d5e434d9214072e53a1afa3407059865f0e5671da4587fa1bcfed89e43cbcc4e9c44de6495aaedb4927e2f83d00012dcd6365c8e1170c9970ee13a4df589f1ad9218e0e30242ee20f537b11da7e0ce2327e1e7e35dd2ddc03a964cfaced5ee54ec68dd80ae5336668f11fd726cf0073e73cac804f393fff317bd0eb1bcaba08897c26e83e2901b98c6f0a9f9cb365442b9653f4384eba20080906449e02c6e0fc148989f8911016f37fe3d0567add004ac1499c1e6512dc8751560cec2863683134f697474fc6d14a112405bea4277f0d6fbde3b103cd1c0ff6ac239ddee2338b6f65469982f5f3d13e8036f2ced0df0055d294d4c7eca80456eb2c3b42bdf8738df287b8aeee4f9a7c912bcc76a5d0d17d23e9c49c39b2c78ded321182c1f636b481be0c16881e85d4b2eff5cabf4220006acb946759e5794a7756af93592c95c610581e5a6e5c531428d16f13b01e2e793af4a39b11b74ec3eea0cbc574f5aada0a7035fd8d945a5f0ae78dbf5aedc93201fe0aab526877e44a9bb07c53cce299c0bbd58000cef57aef0b91df4a78152c684e98b7ef47800394950b7aa0f07c1c265f98340b5bccf1a9144cfb8a8d5d8b5a00b267fd60995ed4aecfb20740529788254708ba2847676a36a0e3481562eaf7b823c8474e4766b0a84ded83b3c7f12508ebe67984dae8e4f55837eb24daf4ae5a0016911d2447789de65d24c1e059b2345fc36c130b4398fe0cbf61f780df6297462ca697f3715259475989556f236fcce571e9790df793be09778c9a8c4fff8732002d7ce4bf97dbf03e15b8732d3a5df2c905e9b4043a7073ad779d61f6a77f064e08934e99e4fd0a764b76621428e83af48e5c8e5fdb098e75a158e43b52d6ea3900314041fde12a3ad4af857d4206a9bffa46383faa4e567dc49a8872d425696fda2af082f2d97e00b68048092f64653149bc185372872b3820f276f0191836751a01c8eadd8799a5a150ee54576a41be462bca212f1b3865e489653fea8f82a3ad2a65ce20251fc77556a7eabc0940bab6ff4facaf4180fbf9e9322f818df856dd3b004c20a2c9c8c36dd0d4fc42fa08344b25ca5be6ed491a771620eb86bd4505dac16203ea535b1b923ab7c8875b670dc41e35813d3fdfc26c94747123677726486a018c3deb66417c09514c51a95e78301b1f18427fbe8aecdea3c411fc34774035285855e459c69023e22ecc89d819cb2390596fb406ed33c1c81eab036caab2b7d0018388106fa9088aedf52d529148cdfe7c39d915e5f679adb4187006cd14d6540c1182aa63b015032eee357d42bc0b227153808f3a18d0c709aa38a5cf8e777f4001a404515a43841515e39184737b58faec2ff3a85bd5deaa8cd5fdb93b8bf1c7b0355905a276b02465b67103be28ee0f23f4b999a700e99cca5cd41625d3dc72ff01aecdd7dc685d9e8e72c7777f58e908b6a6965449639346772881df1163ab84f50e8569370f76ab91f15b5943b403f94597c8b3f2384645d0dfca73c8762d6914005787778f4246591babc2a879991a4df12358dba3a543ad231428c4288e96032a733e2362a0bd805cfb58e4598a25bc92cb0b2363776b38a281922f1b53989707006f6a29cb17f1c025061a605b368b322363ffa4a4d9bdc364c03d6785d89c4a52484ae7beaeace2fd514d2ff818bf03310ed01e88cf4679f7df5df1a7ecf6a80d0115a5dc1338e33da4d5f4c097acd7d3588f02280f2c9a1071b4d7ef01bd087e265cb7d4470f3fa8a11cd92185ead01ecc3df10e612363dbd2b90966157261ffcd01db3c53f19d1bf7baf50d2ab948928ea325245beaa54abeb45d1487af663e7a2a778deb502a713d6ff3e4216d4f4162b3112dd5b94e9082d13dc0e250e890683a00");
	let proof = VersionedFinalityProof::<u32, Signature>::decode(&mut &bytes[..]);
	dbg!(proof);
	// first compile the project.
	let base_dir = env::current_dir()?.parent().unwrap().display().to_string();
	let mut runner = Runner::new(PathBuf::from(&base_dir));
	let mut contract = runner.deploy("BeefyConsensusClientTest").await;

	let mmr_leaf = hex!("003f1e0000ccaf442e2648d278e87dbca890e532ef9cb7cf2058d023903b49567e2943996f550000000000000006000000a9d36172252f275bc8b7851062dff4a29e018355d8626c941f2ad57dfbabecd008ca13222c83d2a481d7b63c356d95bf9366b2a70e907ca3e38fa52e35731537").to_vec();
	let header = hex!("9a28ac82dd089df2f5215ec55ae8b4933f9d58c8c76bf0c0ca1884f3778af2b7a53ba87a649f925c5093914299f42c78ad997b5f69a2ca5dc9ad3357cd0aeb6fd409566fe009ee37e1bbdc43af58c0be65d195bc3f0a5c98568bb12b709ef0d4f3be0806617572612038b856080000000005617572610101ecb27e1850a572d08ff0f4e94a1a557b0ddd7b12158627e442789802aada1553e65d72ecc3a6c0efb9794fb6c2ebf5878da36d6e5b8295cc0f42810beb64c68a").to_vec();
	let commitment = hex!("046d688088bc15df49c90d1823ac81aa90236815062561ccc4352983576013413e17c25a401e00005400000000000000").to_vec();

	let mmr_leaf = MmrLeaf::<u32, H256, H256, H256>::decode(&mut &*mmr_leaf).unwrap();
	let header = Header::<u32, BlakeTwo256>::decode(&mut &*header).unwrap();
	let commitment = Commitment::<u32>::decode(&mut &*commitment).unwrap();

	{
		type H256Hash = [u8; 32];
		let (parent_hash, number, state_root, extrinsics_root, digests) = contract
			.call::<_, (H256Hash, u32, H256Hash, H256Hash, Vec<Token>)>(
				"DecodeHeader",
				(Token::Bytes(header.encode())),
			)
			.await
			.unwrap();

		assert_eq!(&parent_hash, header.parent_hash.as_fixed_bytes());
		assert_eq!(number, header.number);
		assert_eq!(&state_root, header.state_root.as_fixed_bytes());
		assert_eq!(&extrinsics_root, header.extrinsics_root.as_fixed_bytes());
		assert_eq!(header.digest.logs.len(), digests.len());
	}

	{
		let abi = Token::Tuple(vec![
			Token::Array(vec![Token::Tuple(vec![
				Token::FixedBytes(b"mh".to_vec()),
				Token::Bytes(commitment.payload.get_raw(b"mh").unwrap().clone()),
			])]),
			Token::Uint(Uint::from(commitment.block_number)),
			Token::Uint(Uint::from(commitment.validator_set_id)),
		]);
		let encoded = contract.call::<_, Vec<u8>>("EncodeCommitment", (abi,)).await.unwrap();

		assert_eq!(encoded, commitment.encode());
	}

	{
		let abi = Token::Tuple(vec![
			Token::Uint(Uint::from(0)),
			Token::Uint(Uint::from(mmr_leaf.parent_number_and_hash.0)),
			Token::FixedBytes(mmr_leaf.parent_number_and_hash.1.as_bytes().to_vec()),
			Token::Tuple(vec![
				Token::Uint(Uint::from(mmr_leaf.beefy_next_authority_set.id)),
				Token::Uint(Uint::from(mmr_leaf.beefy_next_authority_set.len)),
				Token::FixedBytes(
					mmr_leaf.beefy_next_authority_set.keyset_commitment.as_bytes().to_vec(),
				),
			]),
			Token::FixedBytes(mmr_leaf.leaf_extra.as_bytes().to_vec()),
			Token::Uint(Uint::from(0)),
			Token::Uint(Uint::from(0)),
		]);

		let encoded = contract.call::<_, Vec<u8>>("EncodeLeaf", (abi,)).await.unwrap();

		assert_eq!(encoded, mmr_leaf.encode());
	}

	Ok(())
}
