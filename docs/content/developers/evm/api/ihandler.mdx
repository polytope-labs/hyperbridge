---
title: IHandler
description: API reference for IHandler - interface for verifying and processing ISMP messages.
---

# IHandler

Interface for verifying and processing ISMP messages. The handler validates consensus proofs and state proofs before dispatching messages to applications.

```solidity lineNumbers
interface IHandler
```

## Overview

The Handler is responsible for:
- Verifying consensus proofs from Hyperbridge
- Processing and validating incoming POST requests
- Processing and validating incoming POST responses
- Processing and validating GET responses
- Handling timeout proofs for all message types
- Ensuring messages haven't timed out before delivery
- Preventing duplicate message delivery

All handler methods are **permissionless** - anyone can call them to relay messages.

---

## Functions

### handleConsensus()

Processes a consensus proof to update the consensus state and store new state commitments.

```solidity lineNumbers
function handleConsensus(
    IHost host, 
    bytes calldata proof
) external
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `host` | `IHost` | The IHost contract |
| `proof` | `bytes` | Encoded consensus proof from Hyperbridge |

**Access:** Permissionless (can be called by anyone)

**Process:**
1. Retrieves current consensus state from host
2. Calls consensus client to verify proof
3. Updates consensus state in host if valid
4. Stores new state commitments for finalized blocks
5. Updates latest state machine heights

**Reverts:**
- If consensus client verification fails
- If proof is for a stale height
- If authority set is unknown
- If host is frozen

---

### handlePostRequests()

Processes and delivers POST requests to destination applications.

```solidity lineNumbers
function handlePostRequests(
    IHost host,
    PostRequestMessage calldata request
) external
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `host` | `IHost` | The IHost contract |
| `request` | `PostRequestMessage` | Struct containing proof and requests |

**Access:** Permissionless (can be called by anyone)

**Process:**
1. Verifies state proof against stored commitment
2. For each request:
   - Validates destination matches this chain
   - Checks request hasn't timed out
   - Checks for duplicate delivery
   - Dispatches to destination application
   - Stores request receipt with relayer address

**Reverts:**
- `InvalidMessageDestination()` - Request not for this chain
- `MessageTimedOut()` - Request exceeded timeout
- `DuplicateMessage()` - Request already delivered
- `InvalidProof()` - State proof verification failed
- `HostFrozen()` - Host is frozen

---

### handlePostRequestTimeouts()

Processes timed-out POST requests and triggers refunds.

```solidity lineNumbers
function handlePostRequestTimeouts(
    IHost host,
    PostRequestTimeoutMessage calldata message
) external
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `host` | `IHost` | The IHost contract |
| `message` | `PostRequestTimeoutMessage` | Struct containing timeout proof and requests |

**Access:** Permissionless (can be called by anyone)

**Process:**
1. Verifies timeout proof
2. For each request:
   - Validates timeout timestamp has passed
   - Calls `onPostRequestTimeout()` on source application
   - Refunds relayer fee to payer (only if callback succeeds)

**Important:**
- Application timeout callback is called **before** refund
- If callback reverts, no refund occurs
- Timeout can be resubmitted until callback succeeds

**Reverts:**
- `MessageNotTimedOut()` - Timeout period not elapsed
- `UnknownMessage()` - Request not found

---

### handlePostResponses()

Processes and delivers POST responses to source applications.

```solidity lineNumbers
function handlePostResponses(
    IHost host,
    PostResponseMessage calldata response
) external
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `host` | `IHost` | The IHost contract |
| `response` | `PostResponseMessage` | Struct containing proof and responses |

**Access:** Permissionless (can be called by anyone)

**Process:**
1. Verifies state proof against stored commitment
2. For each response:
   - Validates destination matches this chain
   - Checks response hasn't timed out
   - Verifies response is for a known request
   - Checks request hasn't been responded to already
   - Dispatches to source application
   - Stores response receipt

**Reverts:**
- `InvalidMessageDestination()` - Response not for this chain
- `MessageTimedOut()` - Response exceeded timeout
- `UnknownMessage()` - Request not found
- `DuplicateResponse()` - Request already responded to
- `InvalidProof()` - State proof verification failed

---

### handlePostResponseTimeouts()

Processes timed-out POST responses and triggers refunds.

```solidity lineNumbers
function handlePostResponseTimeouts(
    IHost host,
    PostResponseTimeoutMessage calldata message
) external
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `host` | `IHost` | The IHost contract |
| `message` | `PostResponseTimeoutMessage` | Struct containing timeout proof and responses |

**Access:** Permissionless (can be called by anyone)

**Process:**
1. Verifies timeout proof
2. For each response:
   - Validates timeout timestamp has passed
   - Calls `onPostResponseTimeout()` on source application
   - Refunds relayer fee to payer (only if callback succeeds)

**Important:**
- Application timeout callback is called **before** refund
- If callback reverts, no refund occurs
- Timeout can be resubmitted until callback succeeds

**Reverts:**
- `MessageNotTimedOut()` - Timeout period not elapsed
- `UnknownMessage()` - Response not found

---

### handleGetResponses()

Processes and delivers GET responses with state data to source applications.

```solidity lineNumbers
function handleGetResponses(
    IHost host,
    GetResponseMessage calldata message
) external
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `host` | `IHost` | The IHost contract |
| `message` | `GetResponseMessage` | Struct containing proof and responses |

**Access:** Permissionless (can be called by anyone)

**Process:**
1. Verifies state proof against stored commitment
2. For each response:
   - Validates destination matches this chain
   - Checks response hasn't timed out
   - Verifies response is for a known request
   - Validates storage proofs for each key
   - RLP-decodes storage values
   - Dispatches to source application

**Important:**
- Storage values are RLP-encoded from the state trie
- Values are provided in same order as requested keys
- Empty storage slots return empty bytes

**Reverts:**
- `InvalidMessageDestination()` - Response not for this chain
- `MessageTimedOut()` - Response exceeded timeout
- `UnknownMessage()` - Request not found
- `InvalidProof()` - State proof verification failed

---

### handleGetRequestTimeouts()

Processes timed-out GET requests with cryptographic proof.

```solidity lineNumbers
function handleGetRequestTimeouts(
    IHost host,
    GetTimeoutMessage calldata message
) external
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `host` | `IHost` | The IHost contract |
| `message` | `GetTimeoutMessage` | Struct containing timed-out GET requests, height, and proof |

**Access:** Permissionless (can be called by anyone)

**Process:**
1. Validates challenge period has elapsed for the state commitment
2. Fetches state commitment at the specified height
3. For each timed-out request:
   - Verifies timeout timestamp has passed
   - Verifies request commitment exists
   - Verifies non-membership proof (request was not processed on destination)
   - Calls `onGetTimeout()` on source application via `host.dispatchTimeOut()`

**Important:**
- Requires a non-membership proof showing the request was not processed on the destination chain
- GET requests have no relayer fees, so no refunds occur
- Primarily for cleanup and state management

**Reverts:**
- `ChallengePeriodNotElapsed()` - Challenge period not yet passed
- `StateCommitmentNotFound()` - State commitment doesn't exist at specified height
- `MessageNotTimedOut()` - Timeout period not elapsed
- `UnknownMessage()` - Request commitment not found
- `InvalidProof()` - Non-membership proof verification failed

---


## Events

The IHandler interface does not define any events directly. Events are emitted by the implementation contract.

---

## Structs

### Proof

Merkle Mountain Range proof for message verification.

```solidity lineNumbers
struct Proof {
    StateMachineHeight height;
    bytes32[] multiproof;
    uint256 leafCount;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `height` | `StateMachineHeight` | State machine height where this proof is anchored |
| `multiproof` | `bytes32[]` | Array of merkle tree nodes forming the inclusion proof |
| `leafCount` | `uint256` | Total number of leaves in the MMR at this height |

---

### PostRequestMessage

Batch of POST requests with their merkle proof.

```solidity lineNumbers
struct PostRequestMessage {
    Proof proof;
    PostRequestLeaf[] requests;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `proof` | `Proof` | Merkle proof for verifying the requests |
| `requests` | `PostRequestLeaf[]` | Array of POST requests as MMR leaves |

---

### PostResponseMessage

Batch of POST responses with their merkle proof.

```solidity lineNumbers
struct PostResponseMessage {
    Proof proof;
    PostResponseLeaf[] responses;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `proof` | `Proof` | Merkle proof for verifying the responses |
| `responses` | `PostResponseLeaf[]` | Array of POST responses as MMR leaves |

---

### GetResponseMessage

Batch of GET responses with their merkle proof.

```solidity lineNumbers
struct GetResponseMessage {
    Proof proof;
    GetResponseLeaf[] responses;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `proof` | `Proof` | Merkle proof for verifying the responses |
| `responses` | `GetResponseLeaf[]` | Array of GET responses as MMR leaves |

---

### PostRequestTimeoutMessage

Batch of timed-out POST requests with their non-membership proof.

```solidity lineNumbers
struct PostRequestTimeoutMessage {
    PostRequest[] timeouts;
    StateMachineHeight height;
    bytes[] proof;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `timeouts` | `PostRequest[]` | Array of POST requests that have timed out |
| `height` | `StateMachineHeight` | Height at which the timeout proof is generated |
| `proof` | `bytes[]` | Non-membership proof showing requests were not processed |

---

### PostResponseTimeoutMessage

Batch of timed-out POST responses with their non-membership proof.

```solidity lineNumbers
struct PostResponseTimeoutMessage {
    PostResponse[] timeouts;
    StateMachineHeight height;
    bytes[] proof;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `timeouts` | `PostResponse[]` | Array of POST responses that have timed out |
| `height` | `StateMachineHeight` | Height at which the timeout proof is generated |
| `proof` | `bytes[]` | Non-membership proof showing responses were not processed |

---



### GetTimeoutMessage

Contains timed-out GET requests with cryptographic proof for timeout processing.

```solidity lineNumbers
struct GetTimeoutMessage {
    GetRequest[] timeouts;
    StateMachineHeight height;
    bytes[] proof;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `timeouts` | `GetRequest[]` | Array of GET requests that have timed out |
| `height` | `StateMachineHeight` | Height at which the timeout proof is generated |
| `proof` | `bytes[]` | Non-membership proof showing requests were not processed on destination chain |

---

### PostRequest

Represents a cross-chain message request.

```solidity lineNumbers
struct PostRequest {
    bytes source;
    bytes dest;
    uint64 nonce;
    bytes from;
    bytes to;
    uint64 timeoutTimestamp;
    bytes body;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `source` | `bytes` | Source chain identifier |
| `dest` | `bytes` | Destination chain identifier |
| `nonce` | `uint64` | Unique nonce for this request on the source chain |
| `from` | `bytes` | Source application address that initiated this request |
| `to` | `bytes` | Destination application address to receive this request |
| `timeoutTimestamp` | `uint64` | Unix timestamp when this request expires |
| `body` | `bytes` | Request payload to be delivered to the destination |

---

### PostResponse

Represents a response to a cross-chain POST request.

```solidity lineNumbers
struct PostResponse {
    PostRequest request;
    bytes response;
    uint64 timeoutTimestamp;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `request` | `PostRequest` | The original request being responded to |
| `response` | `bytes` | Response payload to send back to the requester |
| `timeoutTimestamp` | `uint64` | Unix timestamp when this response expires |

---

### GetRequest

Represents a cross-chain state query request.

```solidity lineNumbers
struct GetRequest {
    bytes source;
    bytes dest;
    uint64 nonce;
    address from;
    uint64 timeoutTimestamp;
    bytes[] keys;
    uint64 height;
    bytes context;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `source` | `bytes` | Source chain identifier where the query originated |
| `dest` | `bytes` | Destination chain identifier to query |
| `nonce` | `uint64` | Unique nonce for this request on the source chain |
| `from` | `address` | Address of the application that initiated this query |
| `timeoutTimestamp` | `uint64` | Unix timestamp when this query expires |
| `keys` | `bytes[]` | Storage keys to retrieve from the destination chain |
| `height` | `uint64` | Block height at which to read the state (0 for latest) |
| `context` | `bytes` | Application-specific metadata for tracking the query |

---

### GetResponse

Represents a response to a cross-chain state query.

```solidity lineNumbers
struct GetResponse {
    GetRequest request;
    StorageValue[] values;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `request` | `GetRequest` | The original GET request being responded to |
| `values` | `StorageValue[]` | Retrieved storage values from the queried chain |

---

### StorageValue

Represents a storage key-value pair.

```solidity lineNumbers
struct StorageValue {
    bytes key;
    bytes value;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `key` | `bytes` | Storage key |
| `value` | `bytes` | RLP-encoded storage value |

---

### PostRequestLeaf

Represents a POST request as a leaf in a Merkle Mountain Range tree.

```solidity lineNumbers
struct PostRequestLeaf {
    PostRequest request;
    uint256 index;
    uint256 kIndex;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `request` | `PostRequest` | The POST request data |
| `index` | `uint256` | Position in the MMR leaves array |
| `kIndex` | `uint256` | K-index for MMR proof generation |

---

### PostResponseLeaf

Represents a POST response as a leaf in a Merkle Mountain Range tree.

```solidity lineNumbers
struct PostResponseLeaf {
    PostResponse response;
    uint256 index;
    uint256 kIndex;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `response` | `PostResponse` | The POST response data |
| `index` | `uint256` | Position in the MMR leaves array |
| `kIndex` | `uint256` | K-index for MMR proof generation |

---

### GetResponseLeaf

Represents a GET response as a leaf in a Merkle Mountain Range tree.

```solidity lineNumbers
struct GetResponseLeaf {
    GetResponse response;
    uint256 index;
    uint256 kIndex;
}
```

| Field | Type | Description |
|-------|------|-------------|
| `response` | `GetResponse` | The GET response data |
| `index` | `uint256` | Position in the MMR leaves array |
| `kIndex` | `uint256` | K-index for MMR proof generation |

---

## Errors

Errors that can occur during message handling.

---

### ConsensusClientExpired

```solidity lineNumbers
error ConsensusClientExpired()
```

Thrown when consensus state hasn't been updated within the unbonding period.

---

### HostFrozen

```solidity lineNumbers
error HostFrozen()
```

Thrown when attempting to process messages while host is frozen.

---

### ChallengePeriodNotElapsed

```solidity lineNumbers
error ChallengePeriodNotElapsed()
```

Thrown when trying to use a state commitment before challenge period ends.

---

### StateCommitmentNotFound

```solidity lineNumbers
error StateCommitmentNotFound()
```

Thrown when referenced state commitment doesn't exist.

---

### InvalidMessageDestination

```solidity lineNumbers
error InvalidMessageDestination()
```

Thrown when message destination doesn't match current chain.

---

### MessageTimedOut

```solidity lineNumbers
error MessageTimedOut()
```

Thrown when message has exceeded its timeout period.

---

### MessageNotTimedOut

```solidity lineNumbers
error MessageNotTimedOut()
```

Thrown when attempting to process timeout before timeout period elapsed.

---

### DuplicateMessage

```solidity lineNumbers
error DuplicateMessage()
```

Thrown when message has already been delivered.

---

### UnknownMessage

```solidity lineNumbers
error UnknownMessage()
```

Thrown when request/response commitment is not found.

---

### InvalidProof

```solidity lineNumbers
error InvalidProof()
```

Thrown when state proof verification fails.

---
